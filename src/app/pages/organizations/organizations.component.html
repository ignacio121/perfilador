@if (members) {
  <div>
    <h2>Mis usuarios</h2>
    <a class="text">En este m√≥dulo podr√≠as crear y administrar usuarios. Tambi√©n revisar el registro de modificaciones.</a>
    <table mat-table [dataSource]="members" multiTemplateDataRows class="mat-elevation-z8">

      <!-- Columnas visibles -->

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nombre</th>
        <td mat-cell *matCellDef="let row">{{ row.name }}</td>
      </ng-container>

      <ng-container matColumnDef="rut">
        <th mat-header-cell *matHeaderCellDef>Rut</th>
        <td mat-cell *matCellDef="let row">{{ row.username }}</td>
      </ng-container>

      <ng-container matColumnDef="state">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let row">
          <span
            [ngClass]="row.blocked ? 'estado-bloqueado' : 'estado-activo'">
            {{ row.blocked ? 'Bloqueado' : 'Activo' }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="blocked">
        <th mat-header-cell *matHeaderCellDef>Bloqueado</th>
        <td mat-cell *matCellDef="let row">
          <mat-slide-toggle
           [checked]="row.blocked"
           [disabled]="!tienePermiso('change:status')"
           (change)="onToggleBloqueo(row, $event)"
          />
        </td>
      </ng-container>


      <!-- Columna "expandida" (en una fila nueva) -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
          @if (expandedUserId === row.user_id) {
            <div style="padding: 1rem;">
              <!-- üëá Spinner si est√° cargando -->
              @if (cargandoDetalleId === row.user_id) {
                <div class="spinner-container">
                  <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
                </div>
              } @else {
                <!-- üëá Detalles del usuario -->
                <div class="detalle-usuario">
                  <p><strong>Username:</strong> {{ detallesUsuario?.username }}</p>
                  <p><strong>Correo:</strong> {{ detallesUsuario?.email }}</p>
                  <p><strong>Verificado:</strong> {{ detallesUsuario?.email_verified ? 'S√≠' : 'No' }}</p>
                  <p><strong>Direcci√≥n:</strong> {{ detallesUsuario?.user_metadata?.address }}</p>
                  <p><strong>Organizaciones:</strong></p>
                  <ul>
                    @for (org of detallesUsuario?.organizations; track org.id) {
                      <li>
                        <strong>{{ org.display_name }}</strong> ({{ org.name }})
                        <ul>
                          @for (rol of org.roles; track rol.id) {
                            <li>{{ rol.name }}: {{ rol.description }}</li>
                          }
                        </ul>
                      </li>
                    }
                  </ul>
                </div>
              }
            </div>
          }
        </td>
      </ng-container>

      <!-- Header -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

      <!-- Fila de datos principal -->
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="verDetalle(row.user_id)"
        style="cursor: pointer;"
      ></tr>

      <!-- Fila de detalle -->
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="row-expandida"
      ></tr>

    </table>
  </div>
}
 @else {
  <div>Cargando miembros...</div>
}
